<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>バスルートエディタ</title>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link
      href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
      body {
        margin: 0;
        display: flex;
        height: 100vh;
        font-family: sans-serif;
        overflow: hidden;
      }
      #map {
        flex: 1;
        position: relative;
      }
      #sidebar {
        width: 380px;
        padding: 20px;
        background: #fff;
        overflow-y: auto;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        z-index: 5000;
        display: flex;
        flex-direction: column;
      }
      h2 {
        margin-top: 0;
        font-size: 1.4em;
        color: #00703c;
        border-bottom: 2px solid #00703c;
        padding-bottom: 10px;
      }

      .step-container {
        margin-bottom: 20px;
        padding: 15px;
        border-radius: 8px;
        border: 2px solid #eee;
        transition: 0.3s;
      }
      .step-container.active {
        border-color: #00703c;
        background: #f0fdf4;
      }
      .step-title {
        font-weight: bold;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .step-badge {
        background: #00703c;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
      }
      .step-desc {
        font-size: 0.85em;
        color: #666;
        margin-bottom: 10px;
      }

      .info-box {
        background: #fffbe6;
        border: 1px solid #ffe58f;
        padding: 10px;
        border-radius: 4px;
        font-size: 13px;
        margin-bottom: 10px;
      }

      textarea {
        width: 100%;
        height: 150px;
        font-family: monospace;
        font-size: 10px;
        margin-top: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 8px;
        box-sizing: border-box;
      }

      .controls {
        margin-top: auto;
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding-top: 20px;
      }
      button {
        padding: 12px;
        cursor: pointer;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        transition: 0.2s;
        font-size: 14px;
      }
      button.primary {
        background: #00703c;
        color: white;
      }
      button.primary:hover {
        background: #005a30;
      }
      button.primary:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      button.secondary {
        background: #666;
        color: white;
      }
      button.danger {
        background: #d32f2f;
        color: white;
      }

      .mode-switch {
        margin-bottom: 15px;
        font-size: 14px;
        background: #fff;
        padding: 10px;
        border: 1px solid #00703c;
        border-radius: 6px;
      }
      .mode-switch label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-weight: bold;
        color: #00703c;
      }

      /* バス停デザイン */
      .stop-marker-container {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        pointer-events: auto !important;
        z-index: 100;
      }
      .stop-dot {
        width: 16px;
        height: 16px;
        background: #fff;
        border: 4px solid #00703c;
        border-radius: 50%;
        box-sizing: border-box;
        flex-shrink: 0;
      }
      .stop-label {
        position: absolute;
        right: 22px;
        color: #444;
        font-size: 13px;
        font-weight: bold;
        white-space: nowrap;
        text-shadow:
          2px 2px 0 #fff,
          -2px 2px 0 #fff,
          2px -2px 0 #fff,
          -2px -2px 0 #fff,
          0 0 6px #fff;
        pointer-events: none;
      }
      .stop-marker-container.selected .stop-dot {
        background: #f00 !important;
        border-color: #fff !important;
        box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
      }
      .stop-marker-container.selected .stop-label {
        color: #f00;
      }

      .maplibregl-popup {
        z-index: 6000;
      }
      .maplibregl-popup-content {
        padding: 10px;
        font-size: 14px;
      }
      .popup-btn {
        margin-top: 8px;
        width: 100%;
        padding: 5px;
        font-size: 12px;
        background: #00703c;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      /* レイヤーメニュー UI */
      #layer-control-container {
        position: absolute;
        top: 15px;
        right: 15px;
        z-index: 9000;
      }
      #layer-btn {
        background: white;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        border: 1px solid #ddd;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.2s;
      }
      #layer-btn:hover {
        background: #f8f8f8;
        transform: scale(1.05);
      }
      #layer-btn .material-symbols-outlined {
        font-size: 30px;
        color: #333;
      }

      #layer-menu {
        position: absolute;
        top: 60px;
        right: 0;
        background: white;
        padding: 8px;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        border: 1px solid #eee;
        display: none;
        width: 220px;
      }
      #layer-menu.show {
        display: block;
      }
      .layer-item {
        padding: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        border-radius: 8px;
        font-size: 14px;
        transition: 0.2s;
        color: #444;
      }
      .layer-item:hover {
        background: #f5f5f5;
      }
      .layer-item.active {
        background: #e8f5e9;
        color: #00703c;
        font-weight: bold;
      }
      .layer-item .material-symbols-outlined {
        font-size: 22px;
      }
    </style>
  </head>
  <body>
    <div id="map">
      <div id="layer-control-container">
        <div id="layer-btn" onclick="toggleMenu()" title="地図レイヤー切り替え">
          <span class="material-symbols-outlined">layers</span>
        </div>
        <div id="layer-menu">
          <div class="layer-item active" onclick="switchLayer('pale')">
            <span class="material-symbols-outlined">map</span>淡色地図 (標準)
          </div>
          <div class="layer-item" onclick="switchLayer('std')">
            <span class="material-symbols-outlined">public</span>標準地図
          </div>
          <div class="layer-item" onclick="switchLayer('ortho')">
            <span class="material-symbols-outlined">photo_camera</span>航空写真
          </div>
        </div>
      </div>
    </div>
    <div id="sidebar">
      <h2>ルートエディタ</h2>

      <div id="step-1" class="step-container active">
        <div class="step-title">
          <span class="step-badge">1</span> 始点を選択
        </div>
        <div class="step-desc">バス停をクリックして「始点」に設定。</div>
        <div id="start-info" class="info-box">未選択</div>
      </div>

      <div id="step-2" class="step-container">
        <div class="step-title">
          <span class="step-badge">2</span> ルートを描く
        </div>
        <div class="step-desc">
          適宜モードを切り替えながら、クリックして道を作ります。
        </div>
        <div class="mode-switch">
          <label
            ><input type="checkbox" id="straight-mode" checked /> 直線モード
            (手動)</label
          >
        </div>
        <button class="secondary" onclick="undo()" style="width: 100%">
          一歩戻る
        </button>
      </div>

      <div id="step-3" class="step-container">
        <div class="step-title">
          <span class="step-badge">3</span> 終点を選択
        </div>
        <div class="step-desc">最後のバス停をクリックして「終点」に設定。</div>
        <div id="end-info" class="info-box">未選択</div>
      </div>

      <textarea
        id="output"
        readonly
        placeholder="ここにJSONデータが出力されます"
      ></textarea>

      <div class="controls">
        <button
          class="primary"
          id="copy-btn"
          onclick="copyToClipboard()"
          disabled
        >
          JSON データをコピー
        </button>
        <button class="danger" onclick="resetAll()">最初からやり直す</button>
      </div>
    </div>

    <script>
      let stopsData = {};
      let currentStep = "START";
      let startStopId = null;
      let endStopId = null;
      let waypoints = []; // クリックした点 [lng, lat]
      let segments = []; // 各区間の全座標列のリスト
      let markers = []; // waypoint 各点のマーカー
      let stopMarkers = {};

      const map = new maplibregl.Map({
        container: "map",
        style: {
          version: 8,
          sources: {
            "gsi-pale": {
              type: "raster",
              tiles: [
                "https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png",
              ],
              tileSize: 256,
              attribution: "国土地理院",
              maxzoom: 18,
            },
            "gsi-std": {
              type: "raster",
              tiles: [
                "https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png",
              ],
              tileSize: 256,
              attribution: "国土地理院",
              maxzoom: 18,
            },
            "gsi-ortho": {
              type: "raster",
              tiles: [
                "https://cyberjapandata.gsi.go.jp/xyz/ort/{z}/{x}/{y}.jpg",
              ],
              tileSize: 256,
              attribution: "国土地理院",
              maxzoom: 18,
            },
          },
          layers: [
            {
              id: "ortho-layer",
              type: "raster",
              source: "gsi-ortho",
              layout: { visibility: "none" },
            },
            {
              id: "std-layer",
              type: "raster",
              source: "gsi-std",
              layout: { visibility: "none" },
            },
            {
              id: "pale-layer",
              type: "raster",
              source: "gsi-pale",
              layout: { visibility: "visible" },
            },
          ],
        },
        center: [140.8824, 38.2601],
        zoom: 16,
        hash: true,
      });

      function toggleMenu() {
        document.getElementById("layer-menu").classList.toggle("show");
      }

      function switchLayer(type) {
        map.setLayoutProperty("pale-layer", "visibility", "none");
        map.setLayoutProperty("std-layer", "visibility", "none");
        map.setLayoutProperty("ortho-layer", "visibility", "none");
        if (type === "pale")
          map.setLayoutProperty("pale-layer", "visibility", "visible");
        else if (type === "std")
          map.setLayoutProperty("std-layer", "visibility", "visible");
        else if (type === "ortho")
          map.setLayoutProperty("ortho-layer", "visibility", "visible");
        document
          .querySelectorAll(".layer-item")
          .forEach((el) => el.classList.remove("active"));
        if (event && event.currentTarget)
          event.currentTarget.classList.add("active");
        document.getElementById("layer-menu").classList.remove("show");
      }

      async function loadData() {
        try {
          const res = await fetch("../stops.json");
          stopsData = await res.json();
          addStopMarkers();
        } catch (err) {
          console.error("Data load error:", err);
        }
      }

      function addStopMarkers() {
        Object.keys(stopsData).forEach((id) => {
          const stop = stopsData[id];
          const el = document.createElement("div");
          el.className = "stop-marker-container";
          const label = document.createElement("div");
          label.className = "stop-label";
          label.innerText =
            stop.name + (stop.platform ? ` (${stop.platform}番)` : "");
          el.appendChild(label);
          const dot = document.createElement("div");
          dot.className = "stop-dot";
          el.appendChild(dot);
          const marker = new maplibregl.Marker({ element: el })
            .setLngLat([stop.lng, stop.lat])
            .setPopup(
              new maplibregl.Popup({ offset: 10 }).setHTML(`
                        <b>${stop.name}</b><br><small>${id} / ${stop.platform || "-"}番</small><br>
                        <button class="popup-btn" onclick="selectStop('${id}', 'START')">始点に設定</button>
                        <button class="popup-btn" style="background:#444" onclick="selectStop('${id}', 'END')">終点に設定</button>
                    `),
            )
            .addTo(map);
          stopMarkers[id] = marker;
        });
      }

      window.selectStop = async (id, type) => {
        const stop = stopsData[id];
        if (type === "START") {
          startStopId = id;
          document.getElementById("start-info").innerText =
            `[${id}] ${stop.name}`;
          document
            .querySelectorAll(".stop-marker-container")
            .forEach((el) => el.classList.remove("selected"));
          stopMarkers[id].getElement().classList.add("selected");
          waypoints = [[stop.lng, stop.lat]];
          segments = [];
          currentStep = "DRAWING";
          updateStepUI();
          drawRoute();
        } else if (type === "END") {
          if (!startStopId) return alert("先に始点を選択してください。");
          endStopId = id;
          document.getElementById("end-info").innerText =
            `[${id}] ${stop.name}`;
          await addPoint([stop.lng, stop.lat]);
          currentStep = "COMPLETED";
          updateStepUI();
          updateOutput();
        }
        map.getCanvas().focus();
      };

      map.on("click", async (e) => {
        if (currentStep !== "DRAWING") return;
        const lngLat = [e.lngLat.lng, e.lngLat.lat];
        await addPoint(lngLat);
      });

      async function addPoint(newLngLat) {
        const isStraight = document.getElementById("straight-mode").checked;
        const prevPoint = waypoints[waypoints.length - 1];

        let segmentCoords = [];
        if (isStraight) {
          segmentCoords = [prevPoint, newLngLat];
        } else {
          // OSRMで区間計算
          const url = `https://router.project-osrm.org/route/v1/driving/${prevPoint[0]},${prevPoint[1]};${newLngLat[0]},${newLngLat[1]}?overview=full&geometries=geojson`;
          try {
            const res = await axios.get(url);
            if (res.data.code === "Ok") {
              segmentCoords = res.data.routes[0].geometry.coordinates;
            } else {
              segmentCoords = [prevPoint, newLngLat];
            }
          } catch (e) {
            segmentCoords = [prevPoint, newLngLat];
          }
        }

        waypoints.push(newLngLat);
        segments.push(segmentCoords);

        // マーカー配置
        const marker = new maplibregl.Marker({ color: "#d32f2f" })
          .setLngLat(newLngLat)
          .addTo(map);
        markers.push(marker);

        drawRoute();
        updateOutput();
      }

      function drawRoute() {
        let combined = [];
        segments.forEach((seg) => {
          const s = [...seg];
          if (combined.length > 0) s.shift(); // 先頭の重複を解除
          combined = combined.concat(s);
        });

        const geojson = {
          type: "Feature",
          geometry: { type: "LineString", coordinates: combined },
        };
        if (map.getSource("route")) {
          map.getSource("route").setData(geojson);
        } else {
          map.addSource("route", { type: "geojson", data: geojson });
          map.addLayer({
            id: "route-line",
            type: "line",
            source: "route",
            paint: {
              "line-color": "#d32f2f",
              "line-width": 5,
              "line-opacity": 0.8,
            },
          });
        }
      }

      function undo() {
        if (waypoints.length <= 1) return;
        waypoints.pop();
        segments.pop();
        const marker = markers.pop();
        if (marker) marker.remove();
        drawRoute();
        updateOutput();
      }

      function resetAll() {
        startStopId = null;
        endStopId = null;
        waypoints = [];
        segments = [];
        markers.forEach((m) => m.remove());
        markers = [];
        document.getElementById("start-info").innerText = "未選択";
        document.getElementById("end-info").innerText = "未選択";
        document.getElementById("output").value = "";
        document
          .querySelectorAll(".stop-marker-container")
          .forEach((el) => el.classList.remove("selected"));
        currentStep = "START";
        updateStepUI();
        if (map.getSource("route"))
          map
            .getSource("route")
            .setData({ type: "FeatureCollection", features: [] });
      }

      function updateOutput() {
        if (!startStopId || !endStopId) return;
        let combined = [];
        segments.forEach((seg) => {
          const s = [...seg];
          if (combined.length > 0) s.shift();
          combined = combined.concat(s);
        });
        const patternKey = `${startStopId}|...|${endStopId}`;

        // 読みやすい形式に整形
        const coordsStr = combined
          .map((c) => `      [${c[0]}, ${c[1]}]`)
          .join(",\n");
        const jsonStr = `  "${patternKey}": {
    "coordinates": [
${coordsStr}
    ],
    "stop_indices": [0, ${combined.length - 1}]
  }`;

        document.getElementById("output").value = jsonStr;
      }

      function updateStepUI() {
        document
          .querySelectorAll(".step-container")
          .forEach((el) => el.classList.remove("active"));
        if (currentStep === "START")
          document.getElementById("step-1").classList.add("active");
        if (currentStep === "DRAWING")
          document.getElementById("step-2").classList.add("active");
        if (currentStep === "COMPLETED")
          document.getElementById("step-3").classList.add("active");
        document.getElementById("copy-btn").disabled =
          currentStep !== "COMPLETED";
      }

      function copyToClipboard() {
        const textarea = document.getElementById("output");
        textarea.select();
        document.execCommand("copy");
        alert("JSONデータをコピーしました！");
      }

      loadData();
    </script>
  </body>
</html>
