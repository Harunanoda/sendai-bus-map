<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manual Shapes Viewer</title>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link
      href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <style>
      body {
        margin: 0;
        display: flex;
        height: 100vh;
        font-family: sans-serif;
      }
      #map {
        flex: 1;
      }
      #sidebar {
        width: 350px;
        background: #f8f9fa;
        border-left: 1px solid #ddd;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .header {
        padding: 20px;
        background: #00703c;
        color: white;
      }
      .header h2 {
        margin: 0;
        font-size: 1.2em;
      }
      #stats {
        font-size: 0.8em;
        margin-top: 5px;
      }
      .route-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
      }
      .route-item {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: 0.2s;
      }
      .route-item:hover {
        border-color: #00703c;
        background: #f0fdf4;
      }
      .route-item.active {
        border-color: #00703c;
        background: #e8f5e9;
        border-width: 2px;
      }
      .route-key {
        font-family: monospace;
        font-size: 0.85em;
        color: #666;
        word-break: break-all;
      }
      .route-info {
        margin-top: 8px;
        font-size: 0.9em;
        font-weight: bold;
        color: #333;
      }
      .route-meta {
        margin-top: 5px;
        font-size: 0.8em;
        color: #888;
      }
      .stop-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 4px;
        background: #eee;
        margin-right: 4px;
        font-size: 0.8em;
      }

      .stop-marker {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 0 4px rgba(0, 0, 0, 0.3);
      }
      .stop-marker.waypoint {
        background: #d32f2f;
      }
      .stop-marker.bus-stop {
        background: #00703c;
        width: 16px;
        height: 16px;
        z-index: 1;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="sidebar">
      <div class="header">
        <h2>Manual Shapes 一覧</h2>
        <div id="stats"></div>
      </div>
      <div class="route-list" id="route-list">
        <!-- JSで動的に追加 -->
      </div>
    </div>

    <script>
      let manualShapes = {};
      let stopsData = {};
      let currentMarkers = [];

      const map = new maplibregl.Map({
        container: "map",
        style: {
          version: 8,
          sources: {
            "gsi-pale": {
              type: "raster",
              tiles: [
                "https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png",
              ],
              tileSize: 256,
              attribution: "国土地理院",
            },
          },
          layers: [{ id: "pale-layer", type: "raster", source: "gsi-pale" }],
        },
        center: [140.8824, 38.2601],
        zoom: 14,
      });

      async function init() {
        try {
          const [shapesRes, stopsRes] = await Promise.all([
            fetch("manual_shapes.json"),
            fetch("../stops.json"),
          ]);
          manualShapes = await shapesRes.json();
          stopsData = await stopsRes.json();

          renderList();
          document.getElementById("stats").innerText =
            `${Object.keys(manualShapes).length} 件のルートが登録されています`;
        } catch (err) {
          console.error("Data load error:", err);
          alert("データの読み込みに失敗しました。");
        }
      }

      function renderList() {
        const listEl = document.getElementById("route-list");
        listEl.innerHTML = "";

        Object.entries(manualShapes).forEach(([key, data]) => {
          const stopIds = key.split("|...|");
          const stopNames = stopIds.map((id) =>
            stopsData[id] ? stopsData[id].name : id,
          );

          const item = document.createElement("div");
          item.className = "route-item";
          item.innerHTML = `
                    <div class="route-key">${key}</div>
                    <div class="route-info">${stopNames.join(" → ")}</div>
                    <div class="route-meta">
                        座標数: ${data.coordinates.length} | 停車数: ${data.stop_indices.length}
                    </div>
                `;
          item.onclick = () => selectRoute(key, data, item);
          listEl.appendChild(item);
        });
      }

      function selectRoute(key, data, element) {
        // UI更新
        document
          .querySelectorAll(".route-item")
          .forEach((el) => el.classList.remove("active"));
        element.classList.add("active");

        // マーカークリア
        currentMarkers.forEach((m) => m.remove());
        currentMarkers = [];

        // 経路表示
        const geojson = {
          type: "Feature",
          geometry: { type: "LineString", coordinates: data.coordinates },
        };

        if (map.getSource("active-route")) {
          map.getSource("active-route").setData(geojson);
        } else {
          map.addSource("active-route", { type: "geojson", data: geojson });
          map.addLayer({
            id: "active-route-line",
            type: "line",
            source: "active-route",
            paint: {
              "line-color": "#d32f2f",
              "line-width": 4,
              "line-opacity": 0.8,
            },
          });
        }

        // stop_indicesに基づいたマーカー配置
        const bounds = new maplibregl.LngLatBounds();
        data.coordinates.forEach((coord, idx) => {
          const isStop = data.stop_indices.includes(idx);
          if (isStop) {
            const stopIdIdx = data.stop_indices.indexOf(idx);
            const stopIds = key.split("|...|");
            const stopId = stopIds[stopIdIdx];
            const stopName = stopsData[stopId]
              ? stopsData[stopId].name
              : "不明";

            const el = document.createElement("div");
            el.className = "stop-marker bus-stop";
            const marker = new maplibregl.Marker({ element: el })
              .setLngLat(coord)
              .setPopup(
                new maplibregl.Popup({ offset: 10 }).setHTML(
                  `<b>${stopName}</b><br><small>${stopId}</small><br>index: ${idx}`,
                ),
              )
              .addTo(map);
            currentMarkers.push(marker);
          }
          bounds.extend(coord);
        });

        map.fitBounds(bounds, { padding: 50 });
      }

      init();
    </script>
  </body>
</html>
