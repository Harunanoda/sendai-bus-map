<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>仙台市営バスマップ</title>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link
      href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        font-family: "Hiragino Kaku Gothic ProN", sans-serif;
      }
      #map {
        height: 100vh;
        width: 100%;
        background: #f8f8f8;
      }

      /* バス停：当たり判定を持つコンテナ */
      .stop-marker-container {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        pointer-events: auto !important;
        z-index: 1000;
      }

      /* バス停の丸（16px） */
      .stop-dot {
        width: 16px;
        height: 16px;
        background: #fff;
        border: 4px solid #00703c;
        border-radius: 50%;
        box-sizing: border-box;
        flex-shrink: 0;
      }

      /* バス停名：アイコンの左側に整列 */
      .stop-label {
        position: absolute;
        right: 22px;
        color: #444;
        font-size: 13px;
        font-weight: bold;
        white-space: nowrap;
        text-shadow:
          2px 2px 0 #fff,
          -2px 2px 0 #fff,
          2px -2px 0 #fff,
          -2px -2px 0 #fff,
          0 0 6px #fff;
        pointer-events: none;
      }

      /* バス：当たり判定をしっかり持つコンテナ */
      .bus-marker-container {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        pointer-events: auto !important;
        z-index: 5000;
      }

      /* バスアイコン (Material Symbols) */
      .material-symbols-outlined.bus-icon {
        width: 34px;
        height: 34px;
        font-size: 34px;
        color: #00703c;
        pointer-events: none;
        transition: font-size 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        text-shadow:
          2px 2px 0 #fff,
          -2px 2px 0 #fff,
          2px -2px 0 #fff,
          -2px -2px 0 #fff,
          0 0 4px rgba(0, 0, 0, 0.2);
        font-variation-settings:
          "FILL" 1,
          "wght" 400,
          "GRAD" 0,
          "opsz" 40;
      }

      /* バスの看板 */
      .bus-label {
        position: absolute;
        bottom: 42px;
        left: 50%;
        transform: translateX(-50%);
        color: white;
        background: #d32f2f;
        padding: 3px 10px;
        border-radius: 15px;
        font-size: 11px;
        font-weight: bold;
        border: 2px solid white;
        white-space: nowrap;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        pointer-events: none;
      }

      /* 縮小時スタイル */
      .bus-marker-container.compact .bus-label {
        display: none;
      }
      .bus-marker-container.compact .material-symbols-outlined.bus-icon {
        width: 22px;
        height: 22px;
        font-size: 22px;
      }

      /* パネル共通設定（フローティングへ変更） */
      #bottom-panel {
        position: absolute;
        bottom: 20px;
        left: 20px;
        width: calc(100% - 40px);
        max-width: 400px;
        height: 60%;
        max-height: 80vh;
        background: white;
        z-index: 6000;
        transition: 0.35s cubic-bezier(0.19, 1, 0.22, 1);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        border-radius: 16px;
        display: flex;
        flex-direction: column;
        opacity: 0;
        transform: translateY(20px) scale(0.95);
        pointer-events: none;
        border: 1px solid #eee;
      }

      /* PC表示（左上フローティング） */
      @media (min-width: 768px) {
        #bottom-panel {
          top: 20px;
          bottom: auto;
          left: 20px;
          max-height: calc(100vh - 120px);
        }
      }

      /* スマホ表示（以前のボトムシート感を維持しつつ浮かせる） */
      @media (max-width: 767px) {
        #bottom-panel {
          bottom: 20px;
          left: 10px;
          width: calc(100% - 20px);
        }
      }

      #bottom-panel.open {
        opacity: 1;
        transform: translateY(0) scale(1);
        pointer-events: auto;
      }

      .panel-header {
        padding: 20px 24px 16px 24px;
        border-bottom: 1px solid #f0f0f0;
        position: relative;
      }

      /* Material 3スタイルのIconButton */
      .close-btn {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s;
        border: none;
        z-index: 100;
        -webkit-tap-highlight-color: transparent;
      }
      .close-btn:hover {
        background: rgba(0, 0, 0, 0.08);
      }
      .close-btn:active {
        background: rgba(0, 0, 0, 0.12);
      }
      .material-symbols-outlined {
        font-variation-settings:
          "FILL" 0,
          "wght" 400,
          "GRAD" 0,
          "opsz" 24;
        display: inline-block;
        vertical-align: middle;
      }
      .panel-via {
        font-size: 12px;
        color: #666;
        margin-bottom: 2px;
      }
      .panel-title {
        font-size: 20px;
        font-weight: 800;
        color: #333;
      }
      .office-info {
        font-size: 12px;
        color: #444;
        margin-top: 4px;
        font-weight: bold;
      }
      .panel-content {
        flex: 1;
        overflow-y: auto;
        scroll-behavior: smooth;
      }
      .item-row {
        padding: 18px 24px;
        border-bottom: 1px solid #f8f8f8;
        display: flex;
        align-items: center;
        cursor: pointer;
        transition: background 0.2s;
      }
      .item-row:active {
        background-color: #eee !important;
      }
      .item-row.past {
        color: #ccc;
        background: #fafafa;
      }
      .item-row.future {
        color: #00703c;
        font-weight: bold;
      }
      .item-row.highlight {
        background: #fffde7;
        border-left: 6px solid #fbc02d;
        padding-left: 18px;
      }
      .item-row.next-stop {
        background: #e8f5e9;
        border-left: 6px solid #4caf50;
        padding-left: 18px;
      }
      .item-time {
        width: 65px;
        font-size: 18px;
        letter-spacing: -1px;
      }
      .item-info {
        flex: 1;
        font-size: 16px;
      }
      .item-platform {
        font-size: 11px;
        font-weight: normal;
        color: #666;
        margin-top: 2px;
      }

      /* 右上時計 */
      #clock-container {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 5500;
        background: rgba(255, 255, 255, 0.85);
        padding: 8px 12px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        text-align: right;
        pointer-events: none;
        border: 1px solid #ccc;
      }
      #clock-date {
        font-size: 13px;
        font-weight: bold;
        color: #555;
      }
      #clock-time {
        font-size: 24px;
        font-weight: 900;
        color: #333;
        line-height: 1.1;
      }

      /* レイヤーメニュー UI (route_editor.htmlと共通) */
      #layer-control-container {
        position: absolute;
        top: 85px; /* 時計の下 */
        right: 15px;
        z-index: 9000;
      }
      #layer-btn {
        background: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        border: 1px solid #ddd;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.2s;
      }
      #layer-btn:hover {
        background: #f8f8f8;
        transform: scale(1.05);
      }
      #layer-btn .material-symbols-outlined {
        font-size: 24px;
        color: #333;
      }

      #layer-menu {
        position: absolute;
        top: 45px;
        right: 0;
        background: white;
        padding: 8px;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        border: 1px solid #eee;
        display: none;
        width: 220px;
      }
      #layer-menu.show {
        display: block;
      }
      .layer-item {
        padding: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        border-radius: 8px;
        font-size: 14px;
        transition: 0.2s;
        color: #444;
      }
      .layer-item:hover {
        background: #f5f5f5;
      }
      .layer-item.active {
        background: #e8f5e9;
        color: #00703c;
        font-weight: bold;
      }
      .layer-item .material-symbols-outlined {
        font-size: 22px;
      }

      /* 右下クレジット */
      #attribution-container {
        position: absolute;
        bottom: 10px;
        right: 10px;
        z-index: 5500;
        display: flex;
        align-items: center;
        pointer-events: auto; /* クリックできるようにする */
      }
      #attribution-text {
        display: none; /* 初期は隠す */
        background: rgba(255, 255, 255, 0.85);
        padding: 2px 8px;
        border-radius: 4px;
        margin-right: 5px;
        font-size: 11px;
        border: 1px solid #ccc;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }
      #attribution-btn {
        width: 20px;
        height: 20px;
        background: rgba(255, 255, 255, 0.85);
        border-radius: 50%;
        border: 1px solid #ccc;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        padding: 0;
      }
      .material-symbols-outlined {
        font-variation-settings:
          "FILL" 0,
          "wght" 400,
          "GRAD" 0,
          "opsz" 24;
        display: inline-block;
        vertical-align: middle;
      }
      .attribution-link {
        color: #555;
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <!-- 自作クレジット -->
    <div id="attribution-container">
      <div id="attribution-text">
        <a
          href="https://maps.gsi.go.jp/development/ichiran.html"
          target="_blank"
          rel="noopener"
          class="attribution-link"
          >国土地理院</a
        >
      </div>
      <div id="attribution-btn" onclick="toggleAttribution()">
        <span class="material-symbols-outlined">info</span>
      </div>
    </div>

    <div id="clock-container">
      <div id="clock-date"></div>
      <div id="clock-time"></div>
    </div>

    <!-- レイヤー切り替え -->
    <div id="layer-control-container">
      <div
        id="layer-btn"
        onclick="toggleLayerMenu()"
        title="地図レイヤー切り替え"
      >
        <span class="material-symbols-outlined">layers</span>
      </div>
      <div id="layer-menu">
        <div class="layer-item active" onclick="switchLayer('pale')">
          <span class="material-symbols-outlined">map</span>淡色地図
        </div>
        <div class="layer-item" onclick="switchLayer('ortho')">
          <span class="material-symbols-outlined">photo_camera</span>航空写真
        </div>
      </div>
    </div>
    <div id="bottom-panel">
      <button
        class="close-btn"
        onclick="
          event.stopPropagation();
          closePanel();
        "
        title="閉じる"
      >
        <span class="material-symbols-outlined">close</span>
      </button>
      <div class="panel-header">
        <div id="panel-via" class="panel-via"></div>
        <div id="panel-title" class="panel-title">バス停を選択</div>
        <div id="office-info" class="office-info"></div>
      </div>
      <div id="panel-content" class="panel-content"></div>
    </div>
    <div id="map"></div>

    <script>
      let map,
        stopsData,
        shapesData,
        timetablesData,
        calendarData,
        routesData,
        extraData;
      let busMarkers = {},
        stopMarkers = [];
      let currentPanelTrip = null;
      let activeRouteStopIds = [];

      // クレジット表示の切り替え関数
      function toggleAttribution() {
        const text = document.getElementById("attribution-text");
        text.style.display = text.style.display === "block" ? "none" : "block";
      }

      async function init() {
        stopsData = await fetch("stops.json").then((res) => res.json());
        shapesData = await fetch("shapes.json").then((res) => res.json());
        timetablesData = await fetch("timetables.json").then((res) =>
          res.json(),
        );
        calendarData = await fetch("calendar.json").then((res) => res.json());
        routesData = await fetch("routes.json").then((res) => res.json());
        extraData = await fetch("extra.json").then((res) => res.json());

        map = new maplibregl.Map({
          container: "map",
          style: {
            version: 8,
            glyphs:
              "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",
            sources: {
              gsi: {
                type: "raster",
                tiles: [
                  "https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png",
                ],
                tileSize: 256,
                attribution: "", // 空にして自作要素を使う
                maxzoom: 18,
              },
              "gsi-ortho": {
                type: "raster",
                tiles: [
                  "https://cyberjapandata.gsi.go.jp/xyz/ort/{z}/{x}/{y}.jpg",
                ],
                tileSize: 256,
                attribution: "",
                maxzoom: 18,
              },
            },
            layers: [
              { id: "gsi-layer", type: "raster", source: "gsi" },
              {
                id: "gsi-ortho-layer",
                type: "raster",
                source: "gsi-ortho",
                layout: { visibility: "none" },
              },
            ],
          },
          center: [140.8824, 38.2601],
          zoom: 15,
          attributionControl: false, // デフォルトを完全に無効化
        });

        map.on("load", () => {
          // 矢印アイコンを生成して登録
          const width = 16;
          const height = 16;
          const canvas = document.createElement("canvas");
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext("2d");
          ctx.beginPath();
          ctx.moveTo(2, 4);
          ctx.lineTo(width / 2, height - 4);
          ctx.lineTo(width - 2, 4);
          ctx.strokeStyle = "#ffffff";
          ctx.lineWidth = 3;
          ctx.lineCap = "round";
          ctx.lineJoin = "round";
          ctx.stroke();
          const imageData = ctx.getImageData(0, 0, width, height);
          map.addImage("arrow", imageData);

          updateStopMarkers();
          updateClock();
          setInterval(updateBuses, 5000);
          setInterval(updatePanelState, 2000);
          setInterval(updateClock, 1000);
          updateBuses();
        });

        map.on("moveend", updateStopMarkers);
        map.on("click", (e) => {
          if (e.originalEvent.target.className.includes("maplibregl-canvas"))
            closePanel();
        });
      }

      function toggleLayerMenu() {
        document.getElementById("layer-menu").classList.toggle("show");
      }

      function switchLayer(type) {
        if (type === "pale") {
          map.setLayoutProperty("gsi-layer", "visibility", "visible");
          map.setLayoutProperty("gsi-ortho-layer", "visibility", "none");
        } else {
          map.setLayoutProperty("gsi-layer", "visibility", "none");
          map.setLayoutProperty("gsi-ortho-layer", "visibility", "visible");
        }

        document
          .querySelectorAll(".layer-item")
          .forEach((el) => el.classList.remove("active"));
        if (event && event.currentTarget) {
          event.currentTarget.classList.add("active");
        }
        document.getElementById("layer-menu").classList.remove("show");
      }

      function updateClock() {
        const now = new Date();
        const days = ["日", "月", "火", "水", "木", "金", "土"];
        const dateStr = `${now.getMonth() + 1}/${now.getDate()}(${days[now.getDay()]})`;
        const timeStr = `${now.getHours()}:${now.getMinutes().toString().padStart(2, "0")}`;
        document.getElementById("clock-date").innerText = dateStr;
        document.getElementById("clock-time").innerText = timeStr;
      }

      function isServiceRunningToday(serviceId) {
        const now = new Date();
        const ymd =
          now.getFullYear() +
          String(now.getMonth() + 1).padStart(2, "0") +
          String(now.getDate()).padStart(2, "0");
        const exception = (extraData.calendar_dates || []).find(
          (d) => d.date === ymd && d.service_id === serviceId,
        );
        if (exception) return exception.exception_type === "1";
        const cal = calendarData[serviceId];
        if (!cal || ymd < cal.start || ymd > cal.end) return false;
        const gtfsDayIdx = (now.getDay() + 6) % 7;
        return cal.days[gtfsDayIdx] === "1";
      }

      function timeToSec(t) {
        if (!t) return 0;
        const [h, m, s] = t.split(":").map(Number);
        return h * 3600 + m * 60 + (s || 0);
      }

      function updateBuses() {
        const now = new Date();
        const nowSec =
          now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
        const zoom = map.getZoom();
        const isCompact = zoom < 15.0;

        Object.keys(timetablesData).forEach((routeId) => {
          Object.keys(timetablesData[routeId]).forEach((tripId) => {
            const trip = timetablesData[routeId][tripId];
            if (currentPanelTrip && tripId !== currentPanelTrip.tripId) {
              if (busMarkers[tripId]) {
                busMarkers[tripId].remove();
                delete busMarkers[tripId];
              }
              return;
            }
            if (!isServiceRunningToday(trip.service_id)) return;
            const stops = trip.stops;

            if (
              nowSec >= timeToSec(stops[0].time) &&
              nowSec <= timeToSec(stops[stops.length - 1].time)
            ) {
              const pos = calculateBusPos(trip, nowSec);
              if (!pos) return;

              if (!busMarkers[tripId]) {
                const el = document.createElement("div");
                el.className = "bus-marker-container";
                const rName = routesData[routeId]?.short_name || routeId;
                el.innerHTML = `<div class="bus-label">[${rName}] ${trip.headsign}行</div><span class="material-symbols-outlined bus-icon">directions_bus</span>`;

                const handler = (e) => {
                  e.stopPropagation();
                  // タッチ時のゴーストクリック（背後の要素やパネル内要素への誤反応）を防止
                  if (e.type === "touchstart") e.preventDefault();
                  selectBus(trip.headsign, tripId, routeId);
                };
                el.addEventListener("click", handler);
                el.addEventListener("touchstart", handler, { passive: false });

                busMarkers[tripId] = new maplibregl.Marker({
                  element: el,
                })
                  .setLngLat(pos)
                  .addTo(map);
              } else {
                busMarkers[tripId].setLngLat(pos);
              }

              if (isCompact) {
                busMarkers[tripId].getElement().classList.add("compact");
              } else {
                busMarkers[tripId].getElement().classList.remove("compact");
              }
            } else if (busMarkers[tripId]) {
              busMarkers[tripId].remove();
              delete busMarkers[tripId];
            }
          });
        });
      }

      function calculateBusPos(trip, nowSec) {
        const patternKey = trip.stops.map((s) => s.stop_id).join("|");
        const shapeData = shapesData[patternKey];
        if (!shapeData || !shapeData.coordinates || !shapeData.stop_indices)
          return null;
        const coords = shapeData.coordinates;
        const indices = shapeData.stop_indices;

        for (let i = 0; i < trip.stops.length - 1; i++) {
          const s1 = timeToSec(trip.stops[i].time),
            s2 = timeToSec(trip.stops[i + 1].time);
          if (nowSec >= s1 && nowSec < s2) {
            const timeRatio = (nowSec - s1) / (s2 - s1);
            const targetIndex = Math.floor(
              indices[i] + (indices[i + 1] - indices[i]) * timeRatio,
            );
            return coords[Math.min(targetIndex, coords.length - 1)];
          }
        }
        return null;
      }

      function updateStopMarkers() {
        const zoom = map.getZoom();
        const bounds = map.getBounds();
        stopMarkers.forEach((m) => m.remove());
        stopMarkers = [];

        const activeTripStops = activeRouteStopIds;
        const seen = new Set();

        Object.keys(stopsData).forEach((id) => {
          const stop = stopsData[id];
          const isSelectedRouteStop = activeTripStops.includes(id);

          if (currentPanelTrip && !isSelectedRouteStop) return;
          if (!bounds.contains([stop.lng, stop.lat]) && !isSelectedRouteStop)
            return;
          if (zoom < 13.5 && !isSelectedRouteStop) return;

          if (zoom < 16.5) {
            if (seen.has(stop.name)) return;
            seen.add(stop.name);
          }

          const el = document.createElement("div");
          el.className = "stop-marker-container";

          const label = document.createElement("div");
          label.className = "stop-label";

          if (zoom >= 13.5 || isSelectedRouteStop) {
            label.innerText =
              stop.name +
              (zoom >= 16.5 && stop.platform ? ` (${stop.platform}番)` : "");
            el.appendChild(label);
          }

          const dot = document.createElement("div");
          dot.className = "stop-dot";

          el.appendChild(dot);

          const marker = new maplibregl.Marker({ element: el })
            .setLngLat([stop.lng, stop.lat])
            .addTo(map);

          const handler = (e) => {
            e.stopPropagation();
            if (e.type === "touchstart") e.preventDefault();
            showNextBuses(id);
          };
          el.addEventListener("click", handler);
          el.addEventListener("touchstart", handler, { passive: false });
          stopMarkers.push(marker);
        });
      }

      function showNextBuses(stopId) {
        const stop = stopsData[stopId];
        currentPanelTrip = null;
        document.getElementById("panel-via").innerText = "";

        const zoom = map.getZoom();
        const isGrouped = zoom < 16.5;
        const targetIds = isGrouped
          ? Object.keys(stopsData).filter(
              (id) => stopsData[id].name === stop.name,
            )
          : [stopId];

        const platformText =
          !isGrouped && stop.platform ? ` (${stop.platform}番のりば)` : "";
        document.getElementById("panel-title").innerText =
          stop.name + platformText;
        document.getElementById("office-info").innerText = "時刻表";
        const content = document.getElementById("panel-content");
        content.scrollTop = 0;
        content.innerHTML = "";
        const nowStr = new Date().toTimeString().split(" ")[0];

        const allArrivals = [];
        Object.keys(timetablesData).forEach((rid) => {
          Object.keys(timetablesData[rid]).forEach((tid) => {
            const trip = timetablesData[rid][tid];
            if (!isServiceRunningToday(trip.service_id)) return;
            const st = trip.stops.find((s) => targetIds.includes(s.stop_id));
            if (st) {
              const pole = stopsData[st.stop_id];
              allArrivals.push({
                time: st.time,
                route_id: rid,
                trip_id: tid,
                headsign: trip.headsign,
                platform: pole.platform,
                actual_stop_id: st.stop_id,
                is_past: st.time < nowStr,
              });
            }
          });
        });

        if (allArrivals.length === 0) {
          content.innerHTML =
            "<div style='padding:40px; text-align:center; color:#999;'>本日の運行はありません</div>";
        } else {
          allArrivals.sort((a, b) => a.time.localeCompare(b.time));

          let targetScrollEl = null;
          let firstFutureFound = false;

          allArrivals.forEach((bus) => {
            const div = document.createElement("div");
            // 過去のバスはグレーアウト、次は目立たせる（必要なら）
            div.className = `item-row ${bus.is_past ? "past" : "future"}`;

            // 次に来る最初のバスを特定
            if (!bus.is_past && !firstFutureFound) {
              div.classList.add("next-stop"); // 次のバスを強調
              targetScrollEl = div;
              firstFutureFound = true;
            }

            const platformLabel = bus.platform
              ? `<div class="item-platform">${bus.platform}番のりば</div>`
              : "";
            div.innerHTML = `<div class="item-time">${bus.time.substring(0, 5)}</div><div class="item-info">${routesData[bus.route_id]?.short_name || bus.route_id}系統 ${bus.headsign}行${platformLabel}</div>`;
            div.onclick = () =>
              selectBus(
                bus.headsign,
                bus.trip_id,
                bus.route_id,
                bus.actual_stop_id,
              );
            content.appendChild(div);
          });

          // 自動スクロール：ターゲットが画面の上から1/3くらいに来るように調整
          if (targetScrollEl) {
            setTimeout(() => {
              // offsetTop から コンテナの高さの 1/3 を引くことで、ターゲットを上部に持ってくる（少し過去が見える）
              const targetPos =
                targetScrollEl.offsetTop - content.clientHeight / 3;
              content.scrollTo({ top: targetPos, behavior: "smooth" });
            }, 100);
          } else if (allArrivals.length > 0) {
            // 全て過去の場合は一番下へ（または一番上でもよいが、とりあえずそのまま）
            // ユーザーの要望は「次」の話なので、全て終わっている場合は特段指定なしだが、
            // 一応最後の便が見えるようにしておくと親切かもしれない
            setTimeout(() => {
              content.scrollTop = content.scrollHeight;
            }, 100);
          }
        }
        document.getElementById("bottom-panel").classList.add("open");
        updateStopMarkers();
      }

      async function selectBus(headsign, tripId, routeId, highlightId = null) {
        const trip = timetablesData[routeId][tripId];
        currentPanelTrip = { tripId, routeId, highlightId };
        activeRouteStopIds = trip.stops.map((s) => s.stop_id);

        const routeInfo = routesData[routeId];
        const content = document.getElementById("panel-content");
        content.scrollTop = 0;
        document.getElementById("panel-via").innerText = trip.via
          ? `${trip.via} 経由`
          : "";
        const rName = routeInfo?.short_name || routeId;
        document.getElementById("panel-title").innerText =
          `[${rName}] ${headsign}行`;
        const officeName = extraData.offices[trip.office_id] || "";
        document.getElementById("office-info").innerText = officeName;

        content.innerHTML = "";
        const nowStr = new Date().toTimeString().split(" ")[0];
        let targetScrollEl = null;
        let nextStopId = highlightId;
        if (!highlightId) {
          const next = trip.stops.find((st) => st.time > nowStr);
          if (next) nextStopId = next.stop_id;
        }

        trip.stops.forEach((st, index) => {
          const s = stopsData[st.stop_id];
          const isPast = st.time < nowStr;
          const div = document.createElement("div");
          div.id = `row-${index}`;
          div.className = `item-row ${isPast ? "past" : "future"} ${st.stop_id === highlightId ? "highlight" : ""} ${!highlightId && st.stop_id === nextStopId ? "next-stop" : ""}`;
          const platformLabel = s.platform
            ? `<div class="item-platform">${s.platform}番のりば</div>`
            : "";
          div.innerHTML = `<div class="item-time">${st.time.substring(0, 5)}</div><div class="item-info">${s ? s.name : "..."}${platformLabel}</div>`;
          div.onclick = (e) => {
            e.stopPropagation();
            const isMobile = window.innerWidth < 768;
            map.flyTo({
              center: [s.lng, s.lat],
              zoom: 17,
              speed: 1.2,
              padding: isMobile
                ? { bottom: window.innerHeight * 0.4 }
                : { left: 400 },
            });
          };
          content.appendChild(div);
          if (st.stop_id === nextStopId || st.stop_id === highlightId)
            targetScrollEl = div;
        });

        const patternKey = trip.stops.map((s) => s.stop_id).join("|");
        const shape = shapesData[patternKey];
        if (shape) {
          if (map.getLayer("route-arrows")) map.removeLayer("route-arrows");
          if (map.getLayer("route-line")) map.removeLayer("route-line");
          if (map.getSource("route")) map.removeSource("route");
          map.addSource("route", {
            type: "geojson",
            data: {
              type: "Feature",
              geometry: { type: "LineString", coordinates: shape.coordinates },
            },
          });
          map.addLayer({
            id: "route-line",
            type: "line",
            source: "route",
            paint: {
              "line-color": "#" + (routeInfo.color || "00703c"),
              "line-width": 8,
              "line-opacity": 0.6,
            },
          });
          map.addLayer({
            id: "route-arrows",
            type: "symbol",
            source: "route",
            layout: {
              "symbol-placement": "line",
              "symbol-spacing": 80,
              "icon-image": "arrow",
              "icon-size": 0.5,
              "icon-rotate": 270,
              "icon-allow-overlap": true,
              "icon-ignore-placement": true,
            },
          });
        }
        document.getElementById("bottom-panel").classList.add("open");
        updateStopMarkers();

        if (targetScrollEl) {
          setTimeout(() => {
            content.scrollTop =
              targetScrollEl.offsetTop - content.clientHeight / 2 + 40;
          }, 100);
        }
      }

      function updatePanelState() {
        if (!currentPanelTrip) return;
        const trip =
          timetablesData[currentPanelTrip.routeId][currentPanelTrip.tripId];
        const nowStr = new Date().toTimeString().split(" ")[0];
        let nextStopFound = false;
        trip.stops.forEach((st, index) => {
          const div = document.getElementById(`row-${index}`);
          if (!div) return;
          const isPast = st.time < nowStr;
          const isHighlight = st.stop_id === currentPanelTrip.highlightId;
          let isNextBusStop = false;
          if (!currentPanelTrip.highlightId && !isPast && !nextStopFound) {
            isNextBusStop = true;
            nextStopFound = true;
          }
          div.className = `item-row ${isPast ? "past" : "future"} ${
            isHighlight ? "highlight" : ""
          } ${isNextBusStop ? "next-stop" : ""}`;
        });
      }

      function closePanel() {
        document.getElementById("bottom-panel").classList.remove("open");
        currentPanelTrip = null;
        activeRouteStopIds = [];
        if (map.getLayer("route-arrows")) map.removeLayer("route-arrows");
        if (map.getLayer("route-line")) map.removeLayer("route-line");
        if (map.getSource("route")) map.removeSource("route");
        updateStopMarkers();
      }
      init();
    </script>
  </body>
</html>
